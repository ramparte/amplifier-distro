<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amplifier Slack Simulator</title>
<style>
  :root {
    --sidebar-bg: #19171d;
    --sidebar-active: #1264a3;
    --sidebar-hover: #27242c;
    --sidebar-text: #cfc3cf;
    --sidebar-text-bright: #fff;
    --main-bg: #1a1d21;
    --main-bg-alt: #222529;
    --message-hover: #222529;
    --input-bg: #222529;
    --input-border: #565856;
    --text-primary: #d1d2d3;
    --text-secondary: #ababad;
    --text-muted: #6b6f76;
    --accent: #1264a3;
    --accent-hover: #0b4c8c;
    --green: #2bac76;
    --yellow: #e8a820;
    --red: #e74c3c;
    --purple: #9b59b6;
    --border: #383838;
    --code-bg: #2d2d2d;
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font);
    background: var(--main-bg);
    color: var(--text-primary);
    height: 100vh;
    overflow: hidden;
  }

  /* --- Layout --- */
  .app { display: flex; height: 100vh; }

  .sidebar {
    width: 260px;
    background: var(--sidebar-bg);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    border-right: 1px solid var(--border);
  }

  .main-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .thread-panel {
    width: 380px;
    background: var(--main-bg);
    border-left: 1px solid var(--border);
    display: none;
    flex-direction: column;
    flex-shrink: 0;
  }
  .thread-panel.open { display: flex; }

  /* --- Sidebar --- */
  .sidebar-header {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sidebar-header h2 {
    font-size: 17px;
    font-weight: 900;
    color: var(--sidebar-text-bright);
  }

  .sidebar-header .status {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
  }

  .sidebar-section {
    padding: 12px 0 4px 16px;
    font-size: 13px;
    font-weight: 600;
    color: var(--sidebar-text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .channel-list { list-style: none; }

  .channel-item {
    display: flex;
    align-items: center;
    padding: 4px 16px;
    font-size: 14px;
    color: var(--sidebar-text);
    cursor: pointer;
    gap: 6px;
  }
  .channel-item:hover { background: var(--sidebar-hover); }
  .channel-item.active {
    background: var(--sidebar-active);
    color: var(--sidebar-text-bright);
  }
  .channel-item .hash { font-weight: 400; opacity: 0.7; }
  .channel-item .badge {
    margin-left: auto;
    background: var(--red);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 10px;
    display: none;
  }
  .channel-item .badge.visible { display: inline; }

  .sidebar-footer {
    margin-top: auto;
    padding: 12px 16px;
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  .user-picker {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .user-picker select {
    background: var(--sidebar-hover);
    border: 1px solid rgba(255,255,255,0.15);
    color: var(--sidebar-text-bright);
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 4px;
    flex: 1;
    cursor: pointer;
  }

  .avatar {
    width: 28px; height: 28px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 13px;
    color: #fff;
    flex-shrink: 0;
  }

  .avatar-large {
    width: 36px; height: 36px;
    font-size: 15px;
    border-radius: 6px;
  }

  /* --- Channel Header --- */
  .channel-header {
    padding: 10px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    min-height: 50px;
  }
  .channel-header h3 {
    font-size: 17px;
    font-weight: 900;
  }
  .channel-header .topic {
    font-size: 13px;
    color: var(--text-muted);
    margin-left: 8px;
  }
  .channel-header .actions {
    margin-left: auto;
    display: flex;
    gap: 8px;
  }
  .channel-header .actions button {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  .channel-header .actions button:hover {
    background: var(--main-bg-alt);
    color: var(--text-primary);
  }

  /* --- Messages --- */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 8px 20px;
  }
  .messages::-webkit-scrollbar { width: 8px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 4px;
  }

  .message {
    display: flex;
    gap: 8px;
    padding: 6px 0;
    margin: 1px 0;
    border-radius: 6px;
  }
  .message:hover { background: var(--message-hover); }

  .message-body { flex: 1; min-width: 0; }

  .message-header {
    display: flex;
    align-items: baseline;
    gap: 8px;
  }

  .message-author {
    font-weight: 900;
    font-size: 15px;
    color: var(--text-primary);
  }
  .message-author.bot { color: var(--purple); }

  .message-time {
    font-size: 12px;
    color: var(--text-muted);
  }

  .message-text {
    font-size: 14px;
    line-height: 1.46;
    color: var(--text-primary);
    white-space: pre-wrap;
    word-break: break-word;
    margin-top: 2px;
  }
  .message-text code {
    background: var(--code-bg);
    padding: 1px 4px;
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 12px;
  }
  .message-text pre {
    background: var(--code-bg);
    padding: 8px 12px;
    border-radius: 6px;
    margin: 4px 0;
    overflow-x: auto;
    font-family: var(--font-mono);
    font-size: 12px;
    line-height: 1.4;
  }

  .message-actions {
    display: none;
    margin-top: 4px;
  }
  .message:hover .message-actions { display: flex; gap: 4px; }

  .message-actions button {
    background: var(--main-bg-alt);
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .message-actions button:hover {
    color: var(--text-primary);
    border-color: var(--text-muted);
  }

  /* Thread indicator */
  .thread-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
    font-size: 12px;
    color: var(--accent);
    cursor: pointer;
  }
  .thread-indicator:hover { text-decoration: underline; }

  /* --- Day divider --- */
  .day-divider {
    display: flex;
    align-items: center;
    margin: 16px 0 8px;
    gap: 12px;
  }
  .day-divider::before, .day-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .day-divider span {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  /* --- Typing Indicator --- */
  .typing-indicator {
    padding: 4px 20px 4px 64px;
    font-size: 12px;
    color: var(--text-muted);
    min-height: 22px;
  }
  .typing-dot {
    display: inline-block;
    width: 4px; height: 4px;
    border-radius: 50%;
    background: var(--text-muted);
    animation: blink 1.4s infinite;
    margin: 0 1px;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%,80%,100%{opacity:0.3} 40%{opacity:1} }

  /* --- Input --- */
  .input-area {
    padding: 0 20px 20px;
    flex-shrink: 0;
  }

  .input-wrapper {
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    display: flex;
    align-items: flex-end;
    padding: 8px 12px;
    gap: 8px;
  }
  .input-wrapper:focus-within {
    border-color: var(--accent);
  }

  .input-wrapper textarea {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-family: var(--font);
    font-size: 14px;
    resize: none;
    outline: none;
    max-height: 200px;
    line-height: 1.4;
    min-height: 22px;
  }
  .input-wrapper textarea::placeholder {
    color: var(--text-muted);
  }

  .send-btn {
    background: var(--accent);
    border: none;
    color: #fff;
    width: 32px; height: 32px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: background 0.15s;
  }
  .send-btn:hover { background: var(--accent-hover); }
  .send-btn:disabled { opacity: 0.4; cursor: default; }

  /* --- Quick Actions Bar --- */
  .quick-actions {
    display: flex;
    gap: 4px;
    padding: 4px 20px 8px;
    flex-wrap: wrap;
  }
  .quick-actions button {
    background: var(--main-bg-alt);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 3px 10px;
    border-radius: 12px;
    cursor: pointer;
    white-space: nowrap;
  }
  .quick-actions button:hover {
    background: var(--input-bg);
    color: var(--text-primary);
    border-color: var(--text-muted);
  }

  /* --- Thread Panel --- */
  .thread-header {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    min-height: 50px;
  }
  .thread-header h4 { font-size: 15px; font-weight: 700; }
  .thread-header .close-btn {
    margin-left: auto;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 18px;
    cursor: pointer;
    padding: 4px;
  }
  .thread-header .close-btn:hover { color: var(--text-primary); }

  /* --- Connection Badge --- */
  .conn-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(255,255,255,0.05);
  }
  .conn-badge .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
  }
  .conn-badge .dot.connected { background: var(--green); }
  .conn-badge .dot.disconnected { background: var(--red); }
  .conn-badge .dot.connecting { background: var(--yellow); }

  /* --- Info Bar --- */
  .info-bar {
    padding: 6px 20px;
    background: rgba(18,100,163,0.15);
    border-bottom: 1px solid rgba(18,100,163,0.3);
    font-size: 12px;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .info-bar.hidden { display: none; }

  /* --- Blocks Rendering --- */
  .block-section { margin: 4px 0; }
  .block-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 8px 0;
  }
  .block-actions {
    display: flex;
    gap: 4px;
    margin-top: 4px;
  }
  .block-actions button {
    background: var(--main-bg-alt);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
  }
  .block-actions button:hover {
    border-color: var(--accent);
  }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="status"></div>
      <h2>Amplifier</h2>
      <span class="conn-badge" id="connBadge">
        <span class="dot connecting" id="connDot"></span>
        <span id="connText">connecting</span>
      </span>
    </div>

    <div class="sidebar-section">Channels</div>
    <ul class="channel-list" id="channelList"></ul>

    <div class="sidebar-section">Sessions</div>
    <ul class="channel-list" id="sessionChannels"></ul>

    <div class="sidebar-footer">
      <div class="user-picker">
        <div class="avatar" id="currentAvatar" style="background:#e74c3c">A</div>
        <select id="userSelect">
          <option value="U_ALICE" data-color="#e74c3c">Alice</option>
          <option value="U_BOB" data-color="#3498db">Bob</option>
          <option value="U_CAROL" data-color="#2ecc71">Carol</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Main Panel -->
  <div class="main-panel">
    <div class="channel-header">
      <span style="font-size:18px;opacity:0.5">#</span>
      <h3 id="channelName">amplifier</h3>
      <span class="topic" id="channelTopic">Talk to Amplifier here</span>
      <div class="actions">
        <button onclick="discoverSessions()">Discover</button>
        <button onclick="clearMessages()">Clear</button>
      </div>
    </div>

    <div id="infoBar" class="info-bar hidden"></div>

    <div class="messages" id="messages">
      <div class="day-divider"><span>Today</span></div>
    </div>

    <div class="typing-indicator" id="typingIndicator"></div>

    <div class="quick-actions">
      <button onclick="sendQuick('@amp help')">@amp help</button>
      <button onclick="sendQuick('@amp list')">@amp list</button>
      <button onclick="sendQuick('@amp discover')">@amp discover</button>
      <button onclick="sendQuick('@amp new test session')">@amp new</button>
      <button onclick="sendQuick('@amp status')">@amp status</button>
      <button onclick="sendQuick('@amp projects')">@amp projects</button>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <textarea id="messageInput" rows="1"
          placeholder="Message #amplifier (Shift+Enter for newline)"
          onkeydown="handleKeydown(event)"
          oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendMessage()" id="sendBtn">&#9654;</button>
      </div>
    </div>
  </div>

  <!-- Thread Panel -->
  <div class="thread-panel" id="threadPanel">
    <div class="thread-header">
      <h4>Thread</h4>
      <button class="close-btn" onclick="closeThread()">&times;</button>
    </div>
    <div class="messages" id="threadMessages"></div>
    <div class="input-area">
      <div class="input-wrapper">
        <textarea id="threadInput" rows="1"
          placeholder="Reply in thread..."
          onkeydown="handleThreadKeydown(event)"
          oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendThreadMessage()">&#9654;</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- State ---
const state = {
  ws: null,
  currentChannel: 'C_HUB',
  currentUser: 'U_ALICE',
  channels: {},           // id -> {name, topic, type}
  messages: {},           // channelId -> [{...msg}]
  threads: {},            // parentTs -> [{...msg}]
  activeThread: null,     // parentTs of open thread
  botUserId: 'U_AMP_BOT',
  reconnectTimer: null,
};

const USERS = {
  U_ALICE: { name: 'Alice', color: '#e74c3c' },
  U_BOB:   { name: 'Bob',   color: '#3498db' },
  U_CAROL: { name: 'Carol', color: '#2ecc71' },
  U_AMP_BOT: { name: 'Amplifier', color: '#9b59b6', isBot: true },
};

// --- WebSocket ---
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const url = `${proto}//${location.host}/apps/slack/simulator/ws`;
  updateConnStatus('connecting');

  const ws = new WebSocket(url);
  state.ws = ws;

  ws.onopen = () => {
    updateConnStatus('connected');
    if (state.reconnectTimer) {
      clearTimeout(state.reconnectTimer);
      state.reconnectTimer = null;
    }
  };

  ws.onmessage = (evt) => {
    try {
      const data = JSON.parse(evt.data);
      handleWSEvent(data);
    } catch(e) {
      console.error('WS parse error:', e);
    }
  };

  ws.onclose = () => {
    updateConnStatus('disconnected');
    state.reconnectTimer = setTimeout(connectWS, 3000);
  };

  ws.onerror = () => {
    ws.close();
  };
}

function updateConnStatus(status) {
  const dot = document.getElementById('connDot');
  const text = document.getElementById('connText');
  dot.className = `dot ${status}`;
  text.textContent = status;
}

function handleWSEvent(data) {
  const type = data.type;
  if (type === 'pong') return;

  if (type === 'user_message' || type === 'bot_message') {
    const channelId = data.channel || state.currentChannel;
    const isThread = !!data.thread_ts;

    const msg = {
      type: type,
      text: data.text || '',
      blocks: data.blocks,
      userId: data.user_id,
      userName: data.user_name || USERS[data.user_id]?.name || data.user_id,
      ts: data.ts,
      threadTs: data.thread_ts,
      channel: channelId,
      timestamp: data.timestamp || Date.now()/1000,
    };

    if (isThread) {
      if (!state.threads[data.thread_ts]) state.threads[data.thread_ts] = [];
      state.threads[data.thread_ts].push(msg);
      if (state.activeThread === data.thread_ts) {
        renderThread();
      }
      // Update thread indicator on parent
      updateThreadIndicator(channelId, data.thread_ts);
    } else {
      if (!state.messages[channelId]) state.messages[channelId] = [];
      state.messages[channelId].push(msg);
      if (channelId === state.currentChannel) {
        appendMessage(msg, document.getElementById('messages'));
      } else {
        incrementBadge(channelId);
      }
    }

    // Clear typing on bot response
    if (type === 'bot_message') {
      hideTyping();
    }
  }
}

// --- Sending ---
async function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  autoResize(input);

  // Replace @amp shorthand with proper @mention
  const fullText = text.replace(/@amp\b/g, `<@${state.botUserId}>`);

  showTyping();

  try {
    await fetch('/apps/slack/simulator/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        channel_id: state.currentChannel,
        user_id: state.currentUser,
        text: fullText,
      }),
    });
  } catch(e) {
    console.error('Send failed:', e);
    hideTyping();
  }
}

async function sendThreadMessage() {
  if (!state.activeThread) return;
  const input = document.getElementById('threadInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  autoResize(input);

  const fullText = text.replace(/@amp\b/g, `<@${state.botUserId}>`);

  try {
    await fetch('/apps/slack/simulator/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        channel_id: state.currentChannel,
        user_id: state.currentUser,
        text: fullText,
        thread_ts: state.activeThread,
      }),
    });
  } catch(e) {
    console.error('Thread send failed:', e);
  }
}

function sendQuick(text) {
  document.getElementById('messageInput').value = text;
  sendMessage();
}

// --- Rendering ---
function appendMessage(msg, container) {
  const div = document.createElement('div');
  div.className = 'message';
  div.dataset.ts = msg.ts;
  div.dataset.channel = msg.channel;

  const user = USERS[msg.userId] || { name: msg.userName, color: '#666' };
  const isBot = user.isBot || msg.type === 'bot_message';
  const initial = user.name ? user.name[0].toUpperCase() : '?';
  const timeStr = new Date(msg.timestamp * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  let content = '';
  if (msg.blocks && msg.blocks.length > 0) {
    content = renderBlocks(msg.blocks);
  } else {
    content = `<div class="message-text">${formatText(msg.text)}</div>`;
  }

  div.innerHTML = `
    <div class="avatar ${isBot ? 'avatar-large' : ''}" style="background:${user.color}">${initial}</div>
    <div class="message-body">
      <div class="message-header">
        <span class="message-author ${isBot ? 'bot' : ''}">${escapeHtml(user.name)}</span>
        <span class="message-time">${timeStr}</span>
      </div>
      ${content}
      <div class="message-actions">
        <button onclick="startThread('${msg.ts}')">Reply in thread</button>
      </div>
    </div>
  `;

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function renderBlocks(blocks) {
  return blocks.map(b => {
    if (b.type === 'section') {
      const text = b.text?.text || b.text || '';
      return `<div class="block-section message-text">${formatText(text)}</div>`;
    }
    if (b.type === 'divider') {
      return '<hr class="block-divider">';
    }
    if (b.type === 'actions' && b.elements) {
      const btns = b.elements.map(el => {
        const label = el.text?.text || el.text || 'Action';
        const val = el.value || '';
        return `<button onclick="handleBlockAction('${escapeHtml(val)}')">${escapeHtml(label)}</button>`;
      }).join('');
      return `<div class="block-actions">${btns}</div>`;
    }
    if (b.type === 'header') {
      return `<div class="block-section"><strong>${escapeHtml(b.text?.text || '')}</strong></div>`;
    }
    if (b.type === 'context' && b.elements) {
      const parts = b.elements.map(el => el.text || '').join(' | ');
      return `<div class="block-section" style="font-size:12px;color:var(--text-muted)">${formatText(parts)}</div>`;
    }
    return `<div class="block-section message-text">${escapeHtml(JSON.stringify(b))}</div>`;
  }).join('');
}

function formatText(text) {
  if (!text) return '';
  let s = escapeHtml(text);
  // Bold: *text*
  s = s.replace(/\*([^*]+)\*/g, '<strong>$1</strong>');
  // Code blocks: ```...```
  s = s.replace(/```([^`]+)```/g, '<pre>$1</pre>');
  // Inline code: `text`
  s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Links: <url|label>
  s = s.replace(/&lt;(https?:\/\/[^|>]+)\|([^>]+)&gt;/g, '<a href="$1" target="_blank" style="color:var(--accent)">$2</a>');
  s = s.replace(/&lt;(https?:\/\/[^>]+)&gt;/g, '<a href="$1" target="_blank" style="color:var(--accent)">$1</a>');
  // User mentions: <@U_XXX>
  s = s.replace(/&lt;@(U_[A-Z_]+)&gt;/g, (_, uid) => {
    const u = USERS[uid];
    return `<span style="background:rgba(18,100,163,0.2);color:var(--accent);padding:0 2px;border-radius:3px">@${u ? u.name : uid}</span>`;
  });
  // Strikethrough: ~text~
  s = s.replace(/~([^~]+)~/g, '<s>$1</s>');
  return s;
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// --- Threads ---
function startThread(parentTs) {
  state.activeThread = parentTs;
  document.getElementById('threadPanel').classList.add('open');
  renderThread();
  document.getElementById('threadInput').focus();
}

function closeThread() {
  state.activeThread = null;
  document.getElementById('threadPanel').classList.remove('open');
}

function renderThread() {
  const container = document.getElementById('threadMessages');
  container.innerHTML = '';

  // Show parent message
  const channelMsgs = state.messages[state.currentChannel] || [];
  const parent = channelMsgs.find(m => m.ts === state.activeThread);
  if (parent) {
    appendMessage(parent, container);
    // Divider
    const div = document.createElement('div');
    div.className = 'day-divider';
    div.innerHTML = '<span>Replies</span>';
    container.appendChild(div);
  }

  // Show thread replies
  const replies = state.threads[state.activeThread] || [];
  replies.forEach(m => appendMessage(m, container));
}

function updateThreadIndicator(channelId, parentTs) {
  const msgs = document.querySelectorAll(`.message[data-ts="${parentTs}"][data-channel="${channelId}"]`);
  msgs.forEach(el => {
    if (!el.querySelector('.thread-indicator')) {
      const replies = state.threads[parentTs] || [];
      const ind = document.createElement('div');
      ind.className = 'thread-indicator';
      ind.textContent = `${replies.length} ${replies.length === 1 ? 'reply' : 'replies'}`;
      ind.onclick = () => startThread(parentTs);
      el.querySelector('.message-body').appendChild(ind);
    } else {
      const replies = state.threads[parentTs] || [];
      el.querySelector('.thread-indicator').textContent =
        `${replies.length} ${replies.length === 1 ? 'reply' : 'replies'}`;
    }
  });
}

// --- Channels ---
async function loadChannels() {
  try {
    const resp = await fetch('/apps/slack/simulator/channels');
    const data = await resp.json();
    state.channels = {};
    (data.channels || []).forEach(ch => {
      state.channels[ch.id] = ch;
      if (!state.messages[ch.id]) state.messages[ch.id] = [];
    });
    renderChannels();
  } catch(e) {
    console.error('Failed to load channels:', e);
    // Seed default hub
    state.channels['C_HUB'] = { id: 'C_HUB', name: 'amplifier', topic: 'Talk to Amplifier here', type: 'hub' };
    renderChannels();
  }
}

function renderChannels() {
  const hubList = document.getElementById('channelList');
  const sessionList = document.getElementById('sessionChannels');
  hubList.innerHTML = '';
  sessionList.innerHTML = '';

  Object.values(state.channels).forEach(ch => {
    const li = document.createElement('li');
    li.className = `channel-item ${ch.id === state.currentChannel ? 'active' : ''}`;
    li.innerHTML = `<span class="hash">#</span> ${escapeHtml(ch.name)} <span class="badge" id="badge-${ch.id}"></span>`;
    li.onclick = () => switchChannel(ch.id);
    if (ch.type === 'session') {
      sessionList.appendChild(li);
    } else {
      hubList.appendChild(li);
    }
  });
}

function switchChannel(channelId) {
  state.currentChannel = channelId;
  const ch = state.channels[channelId] || { name: channelId, topic: '' };
  document.getElementById('channelName').textContent = ch.name;
  document.getElementById('channelTopic').textContent = ch.topic || '';
  document.getElementById('messageInput').placeholder = `Message #${ch.name}`;

  // Clear badge
  const badge = document.getElementById(`badge-${channelId}`);
  if (badge) { badge.textContent = ''; badge.classList.remove('visible'); }

  // Render messages
  const container = document.getElementById('messages');
  container.innerHTML = '<div class="day-divider"><span>Today</span></div>';
  (state.messages[channelId] || []).forEach(m => appendMessage(m, container));

  renderChannels();
  closeThread();
  document.getElementById('messageInput').focus();
}

function incrementBadge(channelId) {
  const badge = document.getElementById(`badge-${channelId}`);
  if (!badge) return;
  const count = parseInt(badge.textContent || '0') + 1;
  badge.textContent = count;
  badge.classList.add('visible');
}

// --- Typing ---
function showTyping() {
  document.getElementById('typingIndicator').innerHTML =
    `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span> Amplifier is thinking...`;
}
function hideTyping() {
  document.getElementById('typingIndicator').innerHTML = '';
}

// --- Discovery ---
async function discoverSessions() {
  showInfo('Discovering local sessions...');
  try {
    const resp = await fetch('/apps/slack/discover');
    const sessions = await resp.json();
    if (sessions.length === 0) {
      showInfo('No local Amplifier sessions found.');
    } else {
      showInfo(`Found ${sessions.length} local session(s).`);
      // Show as a bot message
      const text = sessions.map(s =>
        `- *${s.name || s.session_id.slice(0,8)}* (${s.project}) - ${s.date_str}`
      ).join('\n');
      fakeBot(`Found ${sessions.length} local session(s):\n${text}`);
    }
  } catch(e) {
    showInfo('Failed to discover sessions.');
  }
}

function fakeBot(text) {
  const msg = {
    type: 'bot_message',
    text: text,
    userId: 'U_AMP_BOT',
    userName: 'Amplifier',
    ts: `${Date.now()/1000}`,
    channel: state.currentChannel,
    timestamp: Date.now()/1000,
  };
  if (!state.messages[state.currentChannel]) state.messages[state.currentChannel] = [];
  state.messages[state.currentChannel].push(msg);
  appendMessage(msg, document.getElementById('messages'));
}

// --- Block Actions ---
async function handleBlockAction(value) {
  if (value.startsWith('connect_session:')) {
    const sid = value.split(':')[1];
    sendQuick(`@amp connect ${sid}`);
  }
}

// --- Utilities ---
function showInfo(text) {
  const bar = document.getElementById('infoBar');
  bar.textContent = text;
  bar.classList.remove('hidden');
  setTimeout(() => bar.classList.add('hidden'), 5000);
}

function clearMessages() {
  state.messages[state.currentChannel] = [];
  const container = document.getElementById('messages');
  container.innerHTML = '<div class="day-divider"><span>Today</span></div>';
}

function handleKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function handleThreadKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendThreadMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

// --- User picker ---
document.getElementById('userSelect').addEventListener('change', function() {
  state.currentUser = this.value;
  const opt = this.options[this.selectedIndex];
  const color = opt.dataset.color || '#666';
  const avatar = document.getElementById('currentAvatar');
  avatar.style.background = color;
  avatar.textContent = opt.textContent[0].toUpperCase();
});

// --- Init ---
window.addEventListener('DOMContentLoaded', () => {
  loadChannels();
  connectWS();

  // Welcome message
  setTimeout(() => {
    fakeBot(`Welcome to the Amplifier Slack Simulator!\n\nThis is a test environment for the Slack bridge. Try:\n- \`@amp help\` - see available commands\n- \`@amp list\` - list active sessions\n- \`@amp discover\` - find local Amplifier sessions\n- \`@amp new <description>\` - start a new session\n\nUse the user picker in the sidebar to switch between simulated users.`);
  }, 500);

  document.getElementById('messageInput').focus();
});
</script>
</body>
</html>
