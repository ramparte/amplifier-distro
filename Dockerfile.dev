# Amplifier Distro - Development & Testing Image
#
# This image provides an isolated environment for developing and testing
# the amplifier-distro without touching the host's ~/.amplifier/ config.
#
# Build: docker compose build
# Usage: docker compose --profile cli up

FROM ubuntu:24.04

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# System dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core tools
    curl \
    git \
    ca-certificates \
    # Python build deps
    python3 \
    python3-dev \
    python3-pip \
    python3-venv \
    # Node.js (for agent-browser)
    nodejs \
    npm \
    # GitHub CLI dependencies
    gpg \
    # Useful utilities
    jq \
    less \
    vim-tiny \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Install uv (Python package manager)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /usr/local/bin/

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    | gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
    | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*

# Create non-root test user
RUN useradd -m -s /bin/bash testuser \
    && echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set up isolated ~/.amplifier/ directory structure
USER testuser
WORKDIR /home/testuser

RUN mkdir -p \
    /home/testuser/.amplifier/cache \
    /home/testuser/.amplifier/projects \
    /home/testuser/.amplifier/memory \
    /home/testuser/dev

# Environment variables
ENV HOME=/home/testuser
ENV PATH="/home/testuser/.local/bin:${PATH}"
ENV UV_CACHE_DIR=/tmp/uv-cache

WORKDIR /workspace

# Default: interactive shell
CMD ["bash"]
