<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amplifier - Chat</title>
<style>
/* ------------------------------------------------------------------ */
/*  Design Tokens (shared with quickstart.html / settings.html)        */
/* ------------------------------------------------------------------ */
:root {
  --bg-primary: #111827;
  --bg-secondary: #1f2937;
  --bg-card: #374151;
  --text-primary: #f9fafb;
  --text-secondary: #9ca3af;
  --accent: #3b82f6;
  --accent-hover: #2563eb;
  --success: #22c55e;
  --warning: #f59e0b;
  --error: #ef4444;
  --border: #4b5563;
  --radius: 8px;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
}

/* ------------------------------------------------------------------ */
/*  Reset & Base                                                       */
/* ------------------------------------------------------------------ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: var(--font);
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

body {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ------------------------------------------------------------------ */
/*  Header                                                             */
/* ------------------------------------------------------------------ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  z-index: 10;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  font-size: 20px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.session-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.session-badge .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.session-badge.connected { background: rgba(34,197,94,0.15); color: var(--success); }
.session-badge.connected .dot { background: var(--success); }
.session-badge.disconnected { background: rgba(245,158,11,0.15); color: var(--warning); }
.session-badge.disconnected .dot { background: var(--warning); }

.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.settings-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-family: var(--font);
  font-size: 13px;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.15s ease;
}

.settings-btn:hover {
  color: var(--text-primary);
  border-color: var(--text-secondary);
  background: var(--bg-card);
}

.settings-btn svg {
  width: 14px;
  height: 14px;
}

/* ------------------------------------------------------------------ */
/*  Chat Area                                                          */
/* ------------------------------------------------------------------ */
.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  scroll-behavior: smooth;
}

.chat-area::-webkit-scrollbar { width: 6px; }
.chat-area::-webkit-scrollbar-track { background: transparent; }
.chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ------------------------------------------------------------------ */
/*  Messages                                                           */
/* ------------------------------------------------------------------ */
.message {
  display: flex;
  gap: 12px;
  max-width: 720px;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.assistant { align-self: flex-start; }
.message.user { align-self: flex-end; flex-direction: row-reverse; }
.message.system { align-self: center; max-width: 560px; }

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  font-weight: 700;
}

.message.assistant .message-avatar {
  background: linear-gradient(135deg, var(--accent), #8b5cf6);
  color: #fff;
}

.message.user .message-avatar {
  background: var(--bg-card);
  color: var(--text-secondary);
}

.message-content {
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.6;
}

.message.assistant .message-content {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.message.user .message-content {
  background: var(--accent);
  color: #fff;
  border-bottom-right-radius: 4px;
}

.message.system .message-content {
  background: transparent;
  border: 1px dashed var(--border);
  color: var(--text-secondary);
  font-size: 13px;
  text-align: center;
  padding: 10px 16px;
}

.message-content strong { font-weight: 700; }
.message-content em { font-style: italic; color: var(--text-secondary); }

.message.user .message-content em { color: rgba(255,255,255,0.8); }

.message-content p { margin-bottom: 8px; }
.message-content p:last-child { margin-bottom: 0; }

.message-content ul {
  margin: 8px 0;
  padding-left: 20px;
}
.message-content ul li { margin-bottom: 4px; }

.message-content code {
  font-family: var(--mono);
  font-size: 13px;
  background: rgba(0,0,0,0.3);
  padding: 1px 6px;
  border-radius: 4px;
}

.message.user .message-content code {
  background: rgba(0,0,0,0.2);
}

.message-content a {
  color: var(--accent);
  text-decoration: none;
}
.message-content a:hover { text-decoration: underline; }
.message.user .message-content a { color: rgba(255,255,255,0.9); text-decoration: underline; }

/* Typing indicator */
.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 4px 0;
}

.typing-indicator span {
  width: 6px;
  height: 6px;
  background: var(--text-secondary);
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
  30% { opacity: 1; transform: translateY(-4px); }
}

/* ------------------------------------------------------------------ */
/*  Input Area                                                         */
/* ------------------------------------------------------------------ */
.input-area {
  padding: 16px 20px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

.input-wrapper {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  max-width: 760px;
  margin: 0 auto;
}

.input-field {
  flex: 1;
  padding: 12px 16px;
  background: var(--bg-card);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 12px;
  font-family: var(--font);
  font-size: 14px;
  line-height: 1.5;
  outline: none;
  resize: none;
  min-height: 44px;
  max-height: 160px;
  transition: border-color 0.15s ease;
}

.input-field:focus { border-color: var(--accent); }

.input-field::placeholder { color: #6b7280; }

.send-btn {
  width: 44px;
  height: 44px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
  flex-shrink: 0;
}

.send-btn:hover { background: var(--accent-hover); }
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.send-btn svg {
  width: 18px;
  height: 18px;
}

.input-hint {
  text-align: center;
  font-size: 11px;
  color: #6b7280;
  margin-top: 8px;
}

/* ------------------------------------------------------------------ */
/*  Mobile                                                             */
/* ------------------------------------------------------------------ */
@media (max-width: 640px) {
  .header { padding: 10px 14px; }
  .logo { font-size: 17px; }
  .session-badge { font-size: 10px; padding: 2px 8px; }
  .settings-btn span { display: none; }
  .settings-btn { padding: 6px 8px; }
  .chat-area { padding: 16px 12px; gap: 12px; }
  .message { max-width: 100%; }
  .message-avatar { width: 28px; height: 28px; font-size: 12px; }
  .message-content { padding: 10px 12px; font-size: 13px; }
  .input-area { padding: 12px 14px; }
  .input-field { padding: 10px 14px; font-size: 14px; }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="logo">Amplifier</div>
    <div class="session-badge disconnected" id="sessionBadge">
      <span class="dot"></span>
      <span id="sessionStatus">Checking...</span>
    </div>
  </div>
  <div class="header-right">
    <button id="sessionsBtn" onclick="toggleSessions()" title="Sessions" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:14px;padding:4px 8px;border-radius:var(--radius);">Sessions</button>
    <a href="/apps/settings/" class="settings-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
      </svg>
      <span>Settings</span>
    </a>
  </div>
</div>

<div id="sessionsDropdown" style="display:none;position:absolute;right:16px;top:52px;width:300px;max-height:400px;overflow-y:auto;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:20;padding:8px 0;">
    <div style="padding:8px 12px;border-bottom:1px solid var(--border);">
        <button onclick="createNewSession()" style="width:100%;padding:8px;background:var(--accent);color:white;border:none;border-radius:var(--radius);cursor:pointer;font-size:13px;">+ New Session</button>
    </div>
    <div id="sessionsList" style="padding:4px 0;">
        <div style="padding:12px;color:var(--text-secondary);font-size:13px;text-align:center;">No sessions yet</div>
    </div>
</div>

<!-- Chat Messages -->
<div class="chat-area" id="chatArea">
  <!-- Messages are inserted here by JavaScript -->
</div>

<!-- Input -->
<div class="input-area">
  <div class="input-wrapper">
    <textarea
      class="input-field"
      id="messageInput"
      placeholder="Type a message..."
      rows="1"
    ></textarea>
    <button class="send-btn" id="sendBtn" title="Send message">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
  <div class="input-hint">Press Enter to send, Shift+Enter for new line</div>
</div>

<script>
/* ------------------------------------------------------------------ */
/*  State                                                              */
/* ------------------------------------------------------------------ */
let sessionConnected = false;

const chatArea = document.getElementById('chatArea');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const sessionBadge = document.getElementById('sessionBadge');
const sessionStatusEl = document.getElementById('sessionStatus');

/* ------------------------------------------------------------------ */
/*  Message Rendering                                                  */
/* ------------------------------------------------------------------ */
function addMessage(role, html) {
  const msg = document.createElement('div');
  msg.className = 'message ' + role;

  let avatar = '';
  if (role === 'assistant') {
    avatar = '<div class="message-avatar">A</div>';
  } else if (role === 'user') {
    avatar = '<div class="message-avatar">U</div>';
  }

  msg.innerHTML = avatar + '<div class="message-content">' + html + '</div>';
  chatArea.appendChild(msg);
  chatArea.scrollTop = chatArea.scrollHeight;
  return msg;
}

function showTyping() {
  const msg = document.createElement('div');
  msg.className = 'message assistant';
  msg.id = 'typingMsg';
  msg.innerHTML =
    '<div class="message-avatar">A</div>' +
    '<div class="message-content">' +
      '<div class="typing-indicator"><span></span><span></span><span></span></div>' +
    '</div>';
  chatArea.appendChild(msg);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function removeTyping() {
  const el = document.getElementById('typingMsg');
  if (el) el.remove();
}

function esc(str) {
  if (str == null) return '';
  const d = document.createElement('div');
  d.textContent = String(str);
  return d.innerHTML;
}

/* ------------------------------------------------------------------ */
/*  Session Status                                                     */
/* ------------------------------------------------------------------ */
async function checkSession() {
  try {
    const res = await fetch('./api/session');
    const data = await res.json();
    sessionConnected = data.connected === true;
  } catch {
    sessionConnected = false;
  }
  updateBadge();
}

function updateBadge() {
  if (sessionConnected) {
    sessionBadge.className = 'session-badge connected';
    sessionStatusEl.textContent = 'Connected';
  } else {
    sessionBadge.className = 'session-badge disconnected';
    sessionStatusEl.textContent = 'No session';
  }
}

/* ------------------------------------------------------------------ */
/*  Chat Submit                                                        */
/* ------------------------------------------------------------------ */
async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text) return;

  // Show user message
  addMessage('user', '<p>' + esc(text) + '</p>');
  messageInput.value = '';
  autoResize();

  // Auto-create session if needed
  if (!sessionConnected) {
    try {
      const sessionRes = await fetch('./api/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
      });
      if (sessionRes.ok) {
        sessionConnected = true;
        updateBadge();
      } else {
        addMessage('system',
          '<p>Could not create a session (HTTP ' + sessionRes.status + '). ' +
          'Check server logs for details.</p>'
        );
        return;
      }
    } catch {
      addMessage('system',
        '<p>Could not reach the server to create a session. ' +
        'Make sure the Amplifier server is running.</p>'
      );
      return;
    }
  }

  // Send message to backend
  showTyping();
  try {
    const res = await fetch('./api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text }),
    });
    const data = await res.json();
    removeTyping();
    addMessage('assistant', '<p>' + esc(data.response) + '</p>');
  } catch {
    removeTyping();
    addMessage('system',
      '<p>Could not reach the chat API. ' +
      'Make sure the Amplifier server is running.</p>'
    );
  }
}

/* ------------------------------------------------------------------ */
/*  Input Handling                                                     */
/* ------------------------------------------------------------------ */
function autoResize() {
  messageInput.style.height = 'auto';
  messageInput.style.height = Math.min(messageInput.scrollHeight, 160) + 'px';
}

messageInput.addEventListener('input', autoResize);

messageInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

sendBtn.addEventListener('click', sendMessage);

/* ------------------------------------------------------------------ */
/*  Sessions Dropdown                                                  */
/* ------------------------------------------------------------------ */
let sessionsOpen = false;

function toggleSessions() {
    sessionsOpen = !sessionsOpen;
    const dd = document.getElementById('sessionsDropdown');
    if (sessionsOpen) {
        loadSessions();
        dd.style.display = 'block';
    } else {
        dd.style.display = 'none';
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dd = document.getElementById('sessionsDropdown');
    const btn = document.getElementById('sessionsBtn');
    if (sessionsOpen && !dd.contains(e.target) && e.target !== btn) {
        sessionsOpen = false;
        dd.style.display = 'none';
    }
});

async function loadSessions() {
    try {
        const res = await fetch('./api/sessions');
        const data = await res.json();
        renderSessionList(data.sessions || []);
    } catch (e) {
        console.error('Failed to load sessions:', e);
    }
}

function renderSessionList(sessions) {
    const list = document.getElementById('sessionsList');
    if (sessions.length === 0) {
        list.innerHTML = '<div style="padding:12px;color:var(--text-secondary);font-size:13px;text-align:center;">No sessions yet</div>';
        return;
    }
    list.innerHTML = sessions.map(function(s) {
        const shortId = s.session_id.substring(0, 8);
        const desc = s.description || 'Web chat session';
        const time = s.last_active ? new Date(s.last_active).toLocaleString() : '';
        const active = s.is_active;
        const dot = active ? '\u25cf' : '\u25cb';
        const dotColor = active ? 'var(--accent)' : 'var(--text-secondary)';
        const bg = active ? 'var(--bg-card)' : 'transparent';
        return '<div onclick="resumeSessionById(\'' + s.session_id + '\')" style="padding:8px 12px;cursor:pointer;background:' + bg + ';border-left:3px solid ' + (active ? 'var(--accent)' : 'transparent') + ';" onmouseover="this.style.background=\'var(--bg-card)\'" onmouseout="this.style.background=\'' + bg + '\'">'
            + '<div style="font-size:13px;color:var(--text-primary);"><span style="color:' + dotColor + ';">' + dot + '</span> ' + esc(desc) + '</div>'
            + '<div style="font-size:11px;color:var(--text-secondary);margin-top:2px;">' + shortId + ' &middot; ' + esc(time) + '</div>'
            + '</div>';
    }).join('');
}

async function resumeSessionById(sessionId) {
    try {
        const res = await fetch('./api/session/resume', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId }),
        });
        if (res.ok) {
            sessionConnected = true;
            updateBadge();
            chatArea.innerHTML = '';
            addMessage('system', '<p>Resumed session. Continue the conversation below.</p>');
            sessionsOpen = false;
            document.getElementById('sessionsDropdown').style.display = 'none';
        } else {
            const data = await res.json();
            addMessage('system', '<p>Failed to resume: ' + esc(data.error || 'Unknown error') + '</p>');
        }
    } catch (e) {
        addMessage('system', '<p>Failed to resume session.</p>');
    }
}

async function createNewSession() {
    try {
        const res = await fetch('./api/session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
        });
        if (res.ok) {
            sessionConnected = true;
            updateBadge();
            chatArea.innerHTML = '';
            addMessage('system', '<p>New session started.</p>');
            sessionsOpen = false;
            document.getElementById('sessionsDropdown').style.display = 'none';
        }
    } catch (e) {
        addMessage('system', '<p>Failed to create session.</p>');
    }
}

/* ------------------------------------------------------------------ */
/*  Initialization                                                     */
/* ------------------------------------------------------------------ */
(async function init() {
  await checkSession();

  // Welcome message
  addMessage('assistant',
    '<p><strong>Welcome to Amplifier.</strong></p>' +
    '<p>Your AI development environment is configured and ready. ' +
    'This web interface connects to Amplifier sessions so you can chat ' +
    'with your AI assistant from the browser.</p>' +
    '<p><strong>Getting started:</strong></p>' +
    '<ul>' +
      '<li>Use the <code>amplifier</code> CLI for full-featured terminal sessions</li>' +
      '<li>Manage providers and features in <a href="/apps/settings/">Settings</a></li>' +
      '<li>Sessions created via the Bridge API will connect here</li>' +
    '</ul>' +
    '<p><strong>Learn more:</strong></p>' +
    '<ul>' +
      '<li><a href="https://ramparte.github.io/amplifier-tutorial" target="_blank">Tutorial</a> &mdash; step-by-step learning path</li>' +
      '<li><a href="https://github.com/microsoft/amplifier/tree/main/docs" target="_blank">Documentation</a> &mdash; technical guides and reference</li>' +
      '<li><a href="https://ramparte.github.io/amplifier-stories" target="_blank">Stories</a> &mdash; case studies and presentations</li>' +
    '</ul>' +
    (sessionConnected
      ? '<p><em>Session connected &mdash; start chatting below.</em></p>'
      : '<p><em>Send a message to start a session.</em></p>')
  );

  messageInput.focus();
})();
</script>
</body>
</html>
